package com.proutechos.sandbox.radiolivealacarte.server.service;import com.proutechos.sandbox.radiolivealacarte.server.model.Program;import com.proutechos.sandbox.radiolivealacarte.server.model.UserModel;import com.proutechos.utils.server.rest.config.exceptions.ProutechosBaseException;import java.sql.Connection;import java.sql.DriverManager;import java.sql.SQLException;import java.sql.Statement;import java.sql.PreparedStatement;import java.sql.ResultSet;import java.util.ArrayList;import java.util.List;public class RadioLiveALaCarteDataStorage {    public void createAccount(UserModel userModel) throws ProutechosBaseException {        try (                // create a database connection                Connection connection = DriverManager.getConnection("jdbc:sqlite:/Users/eglantine/Dev/0.perso/2.Proutechos/8.RadioStreaming/0.RadioLiveALaCarteServer/0.RadioLiveALaCarteDB/RadioLiveALaCarteDB.db");                Statement statement = connection.createStatement();)        {            statement.setQueryTimeout(5);  // set timeout to 30 sec.            // Impossible de créer deux BankAccount avec le même AccountID.            boolean success = statement.execute("INSERT INTO USERS(id, firstName, lastName) VALUES ('%s', '%s', '%s') ".formatted(                    userModel.getId(),                    userModel.getFirstName(),                    userModel.getLastName()                    )            );        } catch (SQLException ex) {            System.out.println("Error while creating the account");            ex.printStackTrace(System.err);            throw new ProutechosBaseException("Error while creating the account");        }    }    public UserModel getUserById(UserModel userRequested) throws ProutechosBaseException {        String userId = userRequested.getId();        UserModel user = null;  // Initialisation de l'utilisateur à null        String query = "SELECT id, firstName, lastName FROM USERS WHERE id = ?";        try (                // Créer une connexion à la base de données                Connection connection = DriverManager.getConnection("jdbc:sqlite:/Users/eglantine/Dev/0.perso/2.Proutechos/8.RadioStreaming/0.RadioLiveALaCarteServer/0.RadioLiveALaCarteDB/RadioLiveALaCarteDB.db");                PreparedStatement statement = connection.prepareStatement(query);        ) {            statement.setQueryTimeout(5);  // Délai d'attente fixé à 5 secondes            statement.setString(1, userId);  // Assignation de l'id de l'utilisateur            try (ResultSet resultSet = statement.executeQuery()) {                if (resultSet.next()) {  // Vérification si un résultat est retourné                    // Récupération des valeurs de l'utilisateur à partir du ResultSet                    String id = resultSet.getString("id");                    String firstName = resultSet.getString("firstName");                    String lastName = resultSet.getString("lastName");                    // Création d'une instance de User                    user = new UserModel(id, firstName, lastName);                } else {                    System.out.println("User not found with id: " + userId);                }            }        } catch (SQLException ex) {            System.out.println("Error while fetching user with id " + userId);            ex.printStackTrace(System.err);            throw new ProutechosBaseException();        }        return user;  // Retourne l'utilisateur trouvé ou null    }    public void createProgram(Program program) throws ProutechosBaseException {        try (                // Créer une connexion à la base de données                Connection connection = DriverManager.getConnection("jdbc:sqlite:/Users/eglantine/Dev/0.perso/2.Proutechos/8.RadioStreaming/0.RadioLiveALaCarteServer/0.RadioLiveALaCarteDB/RadioLiveALaCarteDB.db");                Statement statement = connection.createStatement();        ) {            statement.setQueryTimeout(5);  // Délai d'attente fixé à 5 secondes.            // Insertion des données du programme dans la table PROGRAMS            String query = """            INSERT INTO PROGRAMS(id, radioName, startTimeHour, startTimeMinute, startTimeSeconds, endTimeHour, endTimeMinute, endTimeSeconds)            VALUES ('%s', '%s', %d, %d, %d, %d, %d, %d)            """.formatted(                    program.getId(),                    program.getRadioName(),                    program.getStartTimeHour(),                    program.getStartTimeMinute(),                    program.getStartTimeSeconds(),                    program.getEndTimeHour(),                    program.getEndTimeMinute(),                    program.getEndTimeSeconds()            );            boolean success = statement.execute(query);            if (success) {                System.out.println("Program created successfully");            } else {                System.out.println("Failed to create the program");            }        } catch (SQLException ex) {            System.out.println("Error while creating the program");            ex.printStackTrace(System.err);            throw new ProutechosBaseException("Error while creating the program");        }    }    public void addUserProgram(UserModel user, Program program) throws ProutechosBaseException {        String query = "INSERT INTO USER_PROGRAM (idUser, idProgram) VALUES (?, ?)";        try (                // Créer une connexion à la base de données                Connection connection = DriverManager.getConnection("jdbc:sqlite:/Users/eglantine/Dev/0.perso/2.Proutechos/8.RadioStreaming/0.RadioLiveALaCarteServer/0.RadioLiveALaCarteDB/RadioLiveALaCarteDB.db");                PreparedStatement statement = connection.prepareStatement(query);        ) {            statement.setQueryTimeout(5);  // Délai d'attente fixé à 5 secondes            statement.setString(1, user.getId());  // Récupération de l'id de l'utilisateur            statement.setString(2, program.getId());  // Récupération de l'id du programme            // Exécution de la requête            int rowsAffected = statement.executeUpdate();            if (rowsAffected > 0) {                System.out.println("User program association created successfully.");            } else {                System.out.println("Failed to create user program association.");            }        } catch (SQLException ex) {            System.out.println("Error while adding user program association");            ex.printStackTrace(System.err);            throw new ProutechosBaseException();        }    }    public List<Program> getProgramsByUser(UserModel user) throws ProutechosBaseException {        List<Program> programs = new ArrayList<>();        String userId = user.getId();        String query = """        SELECT p.id, p.radioName, p.startTimeHour, p.startTimeMinute, p.startTimeSeconds,               p.endTimeHour, p.endTimeMinute, p.endTimeSeconds        FROM PROGRAMS p        JOIN USER_PROGRAM up ON p.id = up.idProgram        WHERE up.idUser = ?            """;        try (                Connection connection = DriverManager.getConnection("jdbc:sqlite:/Users/eglantine/Dev/0.perso/2.Proutechos/8.RadioStreaming/0.RadioLiveALaCarteServer/0.RadioLiveALaCarteDB/RadioLiveALaCarteDB.db");                PreparedStatement statement = connection.prepareStatement(query);        ) {            statement.setQueryTimeout(5);  // set timeout to 5 seconds            statement.setString(1, userId);            try (ResultSet resultSet = statement.executeQuery()) {                while (resultSet.next()) {                    // Récupération des valeurs du programme à partir du ResultSet                    String id = resultSet.getString("id");                    String radioName = resultSet.getString("radioName");                    int startTimeHour = resultSet.getInt("startTimeHour");                    int startTimeMinute = resultSet.getInt("startTimeMinute");                    int startTimeSeconds = resultSet.getInt("startTimeSeconds");                    int endTimeHour = resultSet.getInt("endTimeHour");                    int endTimeMinute = resultSet.getInt("endTimeMinute");                    int endTimeSeconds = resultSet.getInt("endTimeSeconds");                    // Création d'une instance de Program                    Program program = new Program(id, radioName, startTimeHour, startTimeMinute, startTimeSeconds,                            endTimeHour, endTimeMinute, endTimeSeconds);                    // Ajout du programme à la liste                    programs.add(program);                }            }        } catch (SQLException ex) {            System.out.println("Error while fetching programs for user " + userId);            ex.printStackTrace(System.err);            throw new ProutechosBaseException();        }        return programs;    }    public void deleteUserProgram(Program program, UserModel user) throws ProutechosBaseException {        String query = "DELETE FROM USER_PROGRAM WHERE idProgram = ? AND idUser = ?";        String idProgram = program.getId();        String idUser = user.getId();        try (                // Créer une connexion à la base de données                Connection connection = DriverManager.getConnection("jdbc:sqlite:/Users/eglantine/Dev/0.perso/2.Proutechos/8.RadioStreaming/0.RadioLiveALaCarteServer/0.RadioLiveALaCarteDB/RadioLiveALaCarteDB.db");                PreparedStatement statement = connection.prepareStatement(query);        ) {            statement.setQueryTimeout(5);  // Délai d'attente fixé à 5 secondes            // Assignation des paramètres à la requête            statement.setString(1, idProgram);            statement.setString(2, idUser);            // Exécution de la requête            int rowsAffected = statement.executeUpdate();            if (rowsAffected > 0) {                System.out.println("User program association deleted successfully.");            } else {                System.out.println("No association found to delete.");            }        } catch (SQLException ex) {            System.out.println("Error while deleting user program association");            ex.printStackTrace(System.err);            throw new ProutechosBaseException();        }    }    //    //    // SINGLETON    //    //    private static RadioLiveALaCarteDataStorage _instance = new RadioLiveALaCarteDataStorage();    private RadioLiveALaCarteDataStorage() {    }    public static RadioLiveALaCarteDataStorage getInstance() {        return _instance;    }}